name: Build & Release (Windows MSVC 2022, portable) - IDS_DEStruct

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Vers√£o/Tag (ex.: v1.0.0)"
        required: true
        type: string
      prerelease:
        description: "Marcar como pr√©-release?"
        required: false
        default: false
        type: boolean
      notes:
        description: "Notas da release (opcional)"
        required: false
        type: string

permissions:
  contents: write

env:
  VERSION: ${{ github.event.inputs.version }}
  QT_VERSION: "5.15.2"
  ZIP_NAME: IDS_DEStruct-${{ github.event.inputs.version }}-windows-x64.zip

jobs:
  build-windows-msvc:
    name: Windows (MSVC 2022 + Qt5 + Qwt local)
    runs-on: windows-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configurar MSVC 2022
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64
          vsversion: 2022

      - name: Instalar Qt5
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          host: windows
          target: desktop
          arch: win64_msvc2019_64
          modules: qtscript qtsvg
          cache: true

      - name: Validar vers√£o
        shell: pwsh
        run: |
          if ([string]::IsNullOrWhiteSpace($env:VERSION)) {
            throw "Vers√£o n√£o informada"
          }
          Write-Host "‚úî Vers√£o/Tag: $env:VERSION"

      - name: Verificar estrutura do projeto
        shell: pwsh
        run: |
          Write-Host "Verificando arquivos do projeto..."
          if (-not (Test-Path "IDS_DEStruct.pro")) {
            throw "IDS_DEStruct.pro n√£o encontrado"
          }
          if (-not (Test-Path "qwt")) {
            throw "Pasta qwt/ n√£o encontrada"
          }
          if (-not (Test-Path "qwt/lib")) {
            throw "Pasta qwt/lib/ n√£o encontrada"
          }
          if (-not (Test-Path "qwt/src")) {
            throw "Pasta qwt/src/ n√£o encontrada"
          }
          Write-Host "‚úî Estrutura do projeto OK"
          Write-Host "Conte√∫do de qwt/lib:"
          Get-ChildItem -Path "qwt/lib" | Select-Object Name

      - name: Ajustar IDS_DEStruct.pro para CI
        shell: pwsh
        run: |
          Write-Host "Ajustando IDS_DEStruct.pro..."
          
          $proFile = "IDS_DEStruct.pro"
          $content = Get-Content $proFile -Raw
          
          # Remover refer√™ncias a caminhos hardcoded
          $content = $content -replace 'DIRETORIO\s*=\s*C:', '# DIRETORIO = C:'
          $content = $content -replace 'DIRETORIO1\s*=\s*C:', '# DIRETORIO1 = C:'
          
          # Garantir que QWT_LOCATION aponta para a pasta local
          $content = $content -replace 'QWT_LOCATION\s*=\s*[^\r\n]+', 'QWT_LOCATION = $$PWD/qwt'
          
          # Comentar DESTDIR hardcoded
          $content = $content -replace '^(\s*)DESTDIR\s*=\s*\$\$\{DIRETORIO1\}[^\r\n]+', '# $1DESTDIR = (comentado para CI)'
          
          # Adicionar DESTDIR relativo no final se n√£o existir
          if ($content -notmatch 'DESTDIR\s*=\s*\$\$OUT_PWD') {
            $content += "`n`n# ===== CI Configuration =====`n"
            $content += "DESTDIR = `$`$OUT_PWD/release`n"
          }
          
          Set-Content -Path $proFile -Value $content -NoNewline
          
          Write-Host "‚úî IDS_DEStruct.pro ajustado"
          Write-Host "`n--- Trecho relevante do .pro ---"
          Get-Content $proFile | Select-String -Pattern "(QWT_LOCATION|DESTDIR|INCLUDEPATH.*qwt|LIBS.*qwt)" -Context 0,1

      - name: Criar diret√≥rio de build
        shell: pwsh
        run: |
          if (Test-Path "build") {
            Remove-Item -Path "build" -Recurse -Force
          }
          New-Item -ItemType Directory -Path "build" | Out-Null
          Write-Host "‚úî Diret√≥rio build criado"

      - name: Executar qmake
        shell: pwsh
        working-directory: build
        run: |
          Write-Host "Executando qmake..."
          Write-Host "Qt: $env:Qt5_DIR"
          Write-Host "qmake: $(Get-Command qmake -ErrorAction SilentlyContinue | Select-Object -ExpandProperty Source)"
          
          qmake ..\IDS_DEStruct.pro "CONFIG+=release"
          
          if ($LASTEXITCODE -ne 0) {
            throw "qmake falhou com c√≥digo: $LASTEXITCODE"
          }
          Write-Host "‚úî qmake conclu√≠do"

      - name: Compilar com nmake
        shell: pwsh
        working-directory: build
        run: |
          Write-Host "Compilando com nmake..."
          nmake release
          
          if ($LASTEXITCODE -ne 0) {
            throw "nmake falhou com c√≥digo: $LASTEXITCODE"
          }
          Write-Host "‚úî Compila√ß√£o conclu√≠da"

      - name: Localizar execut√°vel
        id: find-exe
        shell: pwsh
        run: |
          Write-Host "Procurando execut√°vel..."
          
          $exePaths = @(
            "build/release/IDS_DEStruct.exe",
            "build/release/IDS_DEStructd.exe",
            "build/IDS_DEStruct.exe",
            "build/release/bin/IDS_DEStruct.exe"
          )
          
          $exeFound = $null
          foreach ($path in $exePaths) {
            if (Test-Path $path) {
              $exeFound = (Resolve-Path $path).Path
              break
            }
          }
          
          if (-not $exeFound) {
            Write-Host "‚ùå Execut√°vel n√£o encontrado nos caminhos esperados"
            Write-Host "Procurando em toda a pasta build..."
            Get-ChildItem -Path "build" -Filter "*.exe" -Recurse | ForEach-Object {
              Write-Host "  Encontrado: $($_.FullName)"
            }
            throw "Execut√°vel n√£o encontrado"
          }
          
          Write-Host "‚úî Execut√°vel encontrado: $exeFound"
          
          $exeDir = Split-Path -Parent $exeFound
          "exe_path=$exeFound" >> $env:GITHUB_OUTPUT
          "exe_dir=$exeDir" >> $env:GITHUB_OUTPUT

      - name: Copiar DLLs do Qwt
        shell: pwsh
        run: |
          $exeDir = "${{ steps.find-exe.outputs.exe_dir }}"
          Write-Host "Copiando DLLs do Qwt para: $exeDir"
          
          $qwtDlls = Get-ChildItem -Path "qwt/lib" -Filter "*.dll"
          foreach ($dll in $qwtDlls) {
            Copy-Item -Path $dll.FullName -Destination $exeDir -Force
            Write-Host "  Copiado: $($dll.Name)"
          }
          Write-Host "‚úî DLLs do Qwt copiadas"

      - name: windeployqt (incluir DLLs do Qt)
        shell: pwsh
        run: |
          $exePath = "${{ steps.find-exe.outputs.exe_path }}"
          $exeDir = "${{ steps.find-exe.outputs.exe_dir }}"
          
          Write-Host "Executando windeployqt em: $exePath"
          
          windeployqt --release --no-translations --no-system-d3d-compiler --no-opengl-sw "$exePath"
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ö†Ô∏è windeployqt retornou c√≥digo: $LASTEXITCODE (continuando...)"
          } else {
            Write-Host "‚úî windeployqt conclu√≠do"
          }
          
          Write-Host "`nConte√∫do do diret√≥rio do execut√°vel:"
          Get-ChildItem -Path $exeDir | Select-Object Name, Length

      - name: Criar pacote ZIP
        shell: pwsh
        run: |
          $exeDir = "${{ steps.find-exe.outputs.exe_dir }}"
          $releaseDir = "release"
          $zipPath = Join-Path $releaseDir $env:ZIP_NAME
          
          if (-not (Test-Path $releaseDir)) {
            New-Item -ItemType Directory -Path $releaseDir | Out-Null
          }
          
          if (Test-Path $zipPath) {
            Remove-Item $zipPath -Force
          }
          
          Write-Host "Criando ZIP: $zipPath"
          Compress-Archive -Path "$exeDir\*" -DestinationPath $zipPath
          
          if (-not (Test-Path $zipPath)) {
            throw "Falha ao criar ZIP"
          }
          
          $zipSize = (Get-Item $zipPath).Length / 1MB
          Write-Host "‚úî ZIP criado com sucesso: $([math]::Round($zipSize, 2)) MB"
          
          "zip_path=$zipPath" >> $env:GITHUB_OUTPUT

      - name: Upload artefato
        uses: actions/upload-artifact@v4
        with:
          name: IDS_DEStruct-${{ env.VERSION }}-windows-x64
          path: release/${{ env.ZIP_NAME }}
          if-no-files-found: error

      - name: Criar Release no GitHub
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          name: IDS_DEStruct ${{ env.VERSION }} (Windows x64)
          body: |
            ${{ github.event.inputs.notes }}
            
            ## üì¶ Download
            - **Windows x64 (MSVC 2022)**: `${{ env.ZIP_NAME }}`
            
            ## üîß Requisitos
            - Windows 10/11 64-bit
            - Microsoft Visual C++ 2022 Redistributable (x64)
            
            ## üìù Changelog
            Veja as mudan√ßas nesta vers√£o nos commits abaixo.
          prerelease: ${{ github.event.inputs.prerelease }}
          files: release/${{ env.ZIP_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
