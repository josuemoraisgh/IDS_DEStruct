name: Build and Create Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Versão/Tag (ex.: v1.0.0, v2.0.0-RC1)'
        required: true
        type: string
      prerelease:
        description: 'Marcar como pré-release?'
        required: false
        default: false
        type: boolean
      notes:
        description: 'Notas da release (opcional)'
        required: false
        type: string

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '5.15.2'
        arch: 'win64_msvc2019_64'
        
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
        
    - name: Create build directory
      run: mkdir -p build
      shell: bash
      
    - name: Generate project files with qmake
      run: cd build && qmake ..\IDS_DEStruct.pro "CONFIG+=release"
      
    - name: Build project with nmake
      run: cd build && nmake
      
    - name: Create release directory structure
      run: |
        mkdir -p release/bin
        mkdir -p release/lib
        mkdir -p release/plugins
      shell: bash
      
    - name: Copy executable
      run: |
        copy build\release\IDS_DEStruct.exe release\bin\
      shell: cmd
      
    - name: Copy QWT libraries
      run: |
        if exist "qwt\lib\qwt.dll" copy qwt\lib\qwt.dll release\lib\
        if exist "qwt\lib\qwtd.dll" copy qwt\lib\qwtd.dll release\lib\
      shell: cmd
      
    - name: Copy Qt runtime libraries
      run: |
        copy "%Qt5_Dir%\bin\Qt5Core.dll" release\bin\
        copy "%Qt5_Dir%\bin\Qt5Gui.dll" release\bin\
        copy "%Qt5_Dir%\bin\Qt5Widgets.dll" release\bin\
        copy "%Qt5_Dir%\bin\Qt5OpenGL.dll" release\bin\
        copy "%Qt5_Dir%\bin\Qt5Svg.dll" release\bin\
        copy "%Qt5_Dir%\bin\Qt5PrintSupport.dll" release\bin\
        copy "%Qt5_Dir%\lib\Qt5Core.lib" release\lib\
        copy "%Qt5_Dir%\lib\Qt5Gui.lib" release\lib\
        copy "%Qt5_Dir%\lib\Qt5Widgets.lib" release\lib\
        copy "%Qt5_Dir%\lib\Qt5OpenGL.lib" release\lib\
        copy "%Qt5_Dir%\lib\Qt5Svg.lib" release\lib\
        copy "%Qt5_Dir%\lib\Qt5PrintSupport.lib" release\lib\
      shell: cmd
      env:
        Qt5_Dir: ${{ env.Qt5_Dir }}
        
    - name: Copy Qt platform plugin
      run: |
        mkdir -p release\plugins\platforms
        copy "%Qt5_Dir%\plugins\platforms\qwindows.dll" release\plugins\platforms\
      shell: cmd
      env:
        Qt5_Dir: ${{ env.Qt5_Dir }}
        
    - name: Copy project files (UI, configs for reference)
      run: |
        mkdir -p release\doc
        copy BUILD.md release\doc\
        copy LOGICA_EVOLUTIVA.md release\doc\
      shell: cmd
      
    - name: Create portable package
      run: |
        7z a IDS_DEStruct-release.7z release\
      shell: cmd
      
    - name: Create ZIP package
      run: |
        powershell -Command "& {Add-Type -AssemblyName System.IO.Compression.FileSystem; [System.IO.Compression.ZipFile]::CreateFromDirectory('release', 'IDS_DEStruct-release.zip')}"
      shell: powershell
      
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.event.inputs.version }}
        name: Release ${{ github.event.inputs.version }}
        files: |
          IDS_DEStruct-release.7z
          IDS_DEStruct-release.zip
        body: |
          # ${{ github.event.inputs.version }}
          
          ${{ github.event.inputs.notes || '## Detalhes da Release\n\n- Build automático via GitHub Actions\n- Compilado com MSVC 2019 (x64)\n- Qt 5.15.2 + Qwt inclusos' }}
          
          ## Informações de Build
          - **Data**: ${{ github.event.repository.updated_at }}
          - **Commit**: ${{ github.sha }}
          - **Disparador**: Workflow dispatch manual
          
          ## Conteúdo
          - IDS_DEStruct.exe (Executável principal)
          - Qt 5.15.2 runtime libraries (Core, Gui, Widgets, OpenGL, Svg, PrintSupport)
          - Bibliotecas Qwt (qwt.dll, qwtd.dll)
          - Platform plugin (qwindows.dll)
          
          ## Instalação
          1. Extraia o arquivo (.7z ou .zip)
          2. Execute `bin/IDS_DEStruct.exe`
          3. As pastas `lib/` e `plugins/` devem estar no mesmo diretório do executável
          
          ## Requisitos
          - Windows 64-bit
          - C++ Runtime (já incluído via Qt)
          
          ## Documentação
          Veja `doc/LOGICA_EVOLUTIVA.md` para detalhes algorítmicos
          
        draft: false
        prerelease: ${{ github.event.inputs.prerelease == 'true' }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
